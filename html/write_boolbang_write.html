<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê¸€ì“°ê¸° - ê´€ë¦¬ì ì „ìš©</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, textarea {
      width: 60%;
      margin: 8px 0;
      padding: 5px;
      font-size: 1rem;
    }
    button {
      padding: 8px 16px;
      cursor: pointer;
    }
    .hint {
      font-size: 0.85rem;
      color: #8000ff;
      margin-bottom: 10px;
    }
    #imagePreview {
      max-width: 60%;
      margin: 10px 0;
      display: none;
      border: 1px solid #aaa;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <h2>ìƒˆ ê¸€ ì‘ì„± (ê´€ë¦¬ì ì „ìš©)</h2>

  <input type="text" id="postWriter" placeholder="ì‘ì„±ì (ê¸°ë³¸: ë¶ˆë°©)" />
  <input type="text" id="postTitle" placeholder="ì œëª©" />

  <div class="hint">
    â€» í˜ì´ì§€ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ë‹¤ë©´ ë³¸ë¬¸ ì•ˆì— <code>[[page]]</code> ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.<br>
    â€» ì‘ì—…ì¤‘ì…ë‹ˆë‹¤. ê´€ë¦¬ìê°€ ì•„ë‹ˆë¼ë©´ êµ³ì´ ì¥ë‚œì¹˜ì§€ ë§ˆì„¸ìš” ã… ã… 
  </div>

  <textarea id="postContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. [[PAGE]] ë¥¼ ë„£ìœ¼ë©´ í˜ì´ì§€ê°€ ë‚˜ë‰©ë‹ˆë‹¤." rows="25"></textarea>

  <input type="text" id="postImageUrl" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)" /><br>

  <!-- âœ… ì´ë¯¸ì§€ íŒŒì¼ ì²¨ë¶€ -->
  <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ (íŒŒì¼ ì„ íƒ):</label><br />
  <input type="file" id="postImageFile" accept="image/*" /><br />
  <img id="imagePreview" alt="ë¯¸ë¦¬ë³´ê¸°" /><br>

  <button onclick="submitPost()">ë“±ë¡</button>

  <hr />
  <h3>ğŸ“ ê²Œì‹œê¸€ ëª©ë¡ (Firestoreì—ì„œ ë¶ˆëŸ¬ì˜´)</h3>
  <div id="adminPostList"></div>

  <!-- Firebase ì—°ë™ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCqAQCELh1q2pWxrXtx-8lBwRe2CTSG_HdQ",
      authDomain: "boolbang-board.firebaseapp.com",
      projectId: "boolbang-board",
      storageBucket: "boolbang-board.appspot.com",
      messagingSenderId: "1563061617526",
      appId: "1:1563061617526:web:066768f311fc53cd017257",
      measurementId: "G-2CBKFZ5Q85"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ê¸€ ë“±ë¡
    async function submitPost() {
      const writer = document.getElementById('postWriter').value.trim() || 'ë¶ˆë°©';
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      const urlInput = document.getElementById('postImageUrl');
      const fileInput = document.getElementById('postImageFile');

      if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (fileInput.files.length > 0) {
        const reader = new FileReader();
        reader.onloadend = async function () {
          const imageDataUrl = reader.result;
          await savePost(writer, title, content, imageDataUrl);
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        const imageUrl = urlInput.value.trim();
        await savePost(writer, title, content, imageUrl || '');
      }
    }

    async function savePost(writer, title, content, image) {
      await addDoc(collection(db, "posts"), {
        title,
        content,
        image,
        author: writer,
        date: new Date().toLocaleString('ko-KR', {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        }),
        views: 0
      });

      alert('ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
      clearWriteForm();
      renderAdminPostList();
    }

    function clearWriteForm() {
      document.getElementById('postWriter').value = '';
      document.getElementById('postTitle').value = '';
      document.getElementById('postContent').value = '';
      document.getElementById('postImageUrl').value = '';
      document.getElementById('postImageFile').value = '';
      document.getElementById('imagePreview').style.display = 'none';
    }

    document.getElementById('postImageFile').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onloadend = function () {
        const preview = document.getElementById('imagePreview');
        preview.src = reader.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    async function renderAdminPostList() {
      const container = document.getElementById('adminPostList');
      container.innerHTML = '';

      const querySnapshot = await getDocs(collection(db, "posts"));
      if (querySnapshot.empty) {
        container.innerHTML = '<p>ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const list = document.createElement('ul');
      querySnapshot.forEach((docSnap) => {
        const post = docSnap.data();
        const li = document.createElement('li');
        li.innerHTML = `[ID: ${docSnap.id}] <strong>${post.title}</strong> - ${post.author} (${post.date}) 
          <button onclick="deletePost('${docSnap.id}')">ì‚­ì œ</button>`;
        list.appendChild(li);
      });

      container.appendChild(list);
    }

    async function deletePost(docId) {
      if (!confirm('ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await deleteDoc(doc(db, "posts", docId));
      alert("ì‚­ì œ ì™„ë£Œ!");
      renderAdminPostList();
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderAdminPostList();
    });
  </script>

</body>
</html>
